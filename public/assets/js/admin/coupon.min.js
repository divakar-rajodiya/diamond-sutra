$(document).ready(function () {
    filterData(couponListUrl, "coupon-table");
});

$(document).on("click", "#add_coupon_modal", function () {
    $("#addCouponModal").modal("show");
});
$(document).on("click", "#add_coupon_btn", function () {
    let isValidCoupon  = $('#is_valid_coupon').val();
    if(isValidCoupon == 1){
        $("#add_coupon_btn").prop("disabled", true);
        $("#add_coupon_form")
            .ajaxForm(function (res) {
                Toast(res.msg, 3000, res.flag);
                if (res.flag == 1) {
                    $("#add_coupon_form")[0].reset();
                    $("#addCouponModal").modal("hide");
                    filterData(couponListUrl, "coupon-table");
                }
                $("#add_coupon_btn").prop("disabled", false);
            })
            .submit();
    } else {
        Toast('Coupon Not Valid!.', 3000, 0);
    }
});




$(document).on('click','#validate_coupon', async function(){
    let base_url = $('#base_url').val();
    let token = $('#token').val();
    let couponCode = $('#coupon_name').val();
    console.log('validate coupon code : ', couponCode);
    $('#validate_coupon').attr('disabled',true);
    $('#validate_coupon').text('Please wait..');
    $.ajax({
        type: 'POST',
        url: base_url + '/admin/coupon/validate',
        data: {
            _token: token,
            coupon_code: couponCode
        },
        success: function (res) {
            console.log(res);
            Toast(res.msg, 3000, res.flag);
            if (res.flag === 1) {
                $('#is_valid_coupon').val(1);
            } else {
                $('#is_valid_coupon').val(0);
            }
            $('#validate_coupon').removeAttr('disabled');
            $('#validate_coupon').text('Validate');
        },
        error: function (xhr, status, error) {
            console.error(error);
            Toast('Ooops! Something went wrong. Try again later.', 3000, 0);
        }
    });
});



function edit(id, name, coupon_type, coupon_note, coupon_for, coupon_for_customer, discount_type, amount,min_amount ,up_to_amount, quantity, expiry_date, status) {
    $("#update_id").val(id);
    $("#update_coupon_name").val(name);
    $("#update_coupon_discount").val(amount);
    $("#update_min_amount").val(min_amount);
    $("#update_discount_type").val(discount_type);
    $("#update_quantity").val(quantity);
    $("#update_coupon_expiry_date").val(expiry_date);
    $("#update_coupon_status").prop("checked", false);
    if (status) $("#update_coupon_status").prop("checked", true);

    // Set the coupon type
    $("#update_coupon_type").val(coupon_type);
    $("#update_coupon_note").val(coupon_note);
    $("#update_up_to_amount").val(up_to_amount);
    if(discount_type == 1){
        $("#update-up-to-amount-div").removeClass('d-none');
    } else {
        $("#update-up-to-amount-div").addClass('d-none');
    }

    // Set the coupon for
    $("#update_coupon_for").val(coupon_for);

    // Show the customer mobile section if coupon is for specific customers
    if (coupon_for == 1) {
        $("#update_customer_mobile_section").removeClass("d-none");
        $("#update_coupon_for_customer").val(coupon_for_customer);
    } else {
        $("#update_customer_mobile_section").addClass("d-none");
        $("#update_coupon_for_customer").val('');
    }

    $("#editCouponModal").modal("show");
}

$(document).on('change','#update_discount_type', function (){
    let type = $(this).val();
    if (type == 1) {
        $('#update-up-to-amount-div').removeClass('d-none');
    } else {
        $('#update-up-to-amount-div').addClass('d-none');
    }
});

$(document).on("click", "#update_coupon_btn", function () {
    $("#update_coupon_btn").prop("disabled", true);
    $("#update_coupon_form")
        .ajaxForm(function (res) {
            Toast(res.msg, 3000, res.flag);
            if (res.flag == 1) {
                $("#update_coupon_form")[0].reset();
                $("#editCouponModal").modal("hide");
                filterData(couponListUrl, "coupon-table");
            }
            $("#update_coupon_btn").prop("disabled", false);
        })
        .submit();
});

function Delete(id) {
    $("#delete_id").val(id);
    $("#deleteCouponModal").modal("show");
}

$(document).on("click", "#delete_coupon_btn", function () {
    $("#delete_coupon_btn").prop("disabled", true);
    $("#delete_coupon_form")
        .ajaxForm(function (res) {
            Toast(res.msg, 3000, res.flag);
            if (res.flag == 1) {
                $("#delete_coupon_form")[0].reset();
                $("#deleteCouponModal").modal("hide");
                filterData(couponListUrl, "coupon-table");
            }
            $("#delete_coupon_btn").prop("disabled", false);
        })
        .submit();
});
